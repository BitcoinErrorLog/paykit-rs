# Paykit Subscriptions Test Suite

This directory contains comprehensive tests for the paykit-subscriptions crate.

## Test Files

- **`property_tests.rs`** - Property-based tests for subscription logic
  - Signature verification
  - Nonce uniqueness
  - Amount calculations
  - Spending limit enforcement
  - Uses proptest for exhaustive testing

- **`spending_limit_tests.rs`** - Spending limit enforcement tests
  - Per-peer spending limits
  - Time-based limit windows
  - Concurrent access safety
  - Limit reset logic

- **`concurrency_tests.rs`** - Thread safety and concurrent access tests
  - Multiple simultaneous payment requests
  - Nonce store race conditions
  - Manager thread safety
  - Auto-pay rule concurrent updates

- **`property_tests.proptest-regressions`** - Proptest regression cases
  - Automatically generated by proptest when failures are found
  - Ensures failures don't reoccur

## Running Tests

```bash
# Run all subscription tests
cargo test -p paykit-subscriptions

# Run specific test file
cargo test -p paykit-subscriptions --test property_tests

# Run with proptest verbose output
cargo test -p paykit-subscriptions --test property_tests -- --nocapture

# Run only specific test
cargo test -p paykit-subscriptions test_nonce_uniqueness
```

## Test Coverage

- **Security**: Signature verification, replay protection
- **Safety**: Overflow protection, spending limits
- **Concurrency**: Thread-safe operations
- **Edge Cases**: Invalid inputs, expired requests, exceeded limits

All tests use the standard Rust test harness with tokio for async tests and proptest for property-based testing.

